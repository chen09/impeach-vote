#!/bin/bash

# Docker ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹ãŸã‚ã®ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
set -e

echo "ğŸ”§ Docker ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ä¿®æ­£ã—ã¾ã™..."

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç¢ºèª
echo "ğŸ“‚ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"

# .env ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
if [ ! -f .env ]; then
    echo "âŒ .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    exit 1
fi

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
echo "ğŸ’¾ .env ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™..."
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)

# ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
echo "ğŸ” ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¾ã™..."
HOST_IP=$(hostname -I | awk '{print $1}')
echo "ğŸ“Š ãƒ›ã‚¹ãƒˆIP: $HOST_IP"

# ç¾åœ¨ã®DATABASE_URLã‚’ç¢ºèª
CURRENT_DB_URL=$(grep "DATABASE_URL" .env | cut -d '=' -f2 | tr -d '"')
echo "ğŸ“Š ç¾åœ¨ã®DATABASE_URL: $CURRENT_DB_URL"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URLã‚’ä¿®æ­£
echo "ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URLã‚’ä¿®æ­£ã—ã¾ã™..."

# è¤‡æ•°ã®é¸æŠè‚¢ã‚’æä¾›
echo "ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š"
echo "1. ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ ($HOST_IP)"
echo "2. 172.17.0.1 (Docker ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒªãƒƒã‚¸)"
echo "3. ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹"
echo "4. ã‚«ã‚¹ã‚¿ãƒ IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›"

read -p "é¸æŠã—ã¦ãã ã•ã„ (1-4): " choice

case $choice in
    1)
        NEW_HOST="$HOST_IP"
        ;;
    2)
        NEW_HOST="172.17.0.1"
        ;;
    3)
        echo "åˆ©ç”¨å¯èƒ½ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼š"
        ip addr show | grep "inet " | grep -v "127.0.0.1"
        read -p "IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: " NEW_HOST
        ;;
    4)
        read -p "ã‚«ã‚¹ã‚¿ãƒ IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: " NEW_HOST
        ;;
    *)
        echo "ç„¡åŠ¹ãªé¸æŠã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ›ã‚¹ãƒˆIPã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
        NEW_HOST="$HOST_IP"
        ;;
esac

# æ–°ã—ã„DATABASE_URLã‚’ä½œæˆ
NEW_DB_URL="mysql://impeach:alHoSitIOnce@$NEW_HOST:3306/impeach"

# .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
sed -i "s|DATABASE_URL=.*|DATABASE_URL=\"$NEW_DB_URL\"|" .env

echo "âœ… DATABASE_URL ã‚’ä¿®æ­£ã—ã¾ã—ãŸ:"
echo "ğŸ“Š æ–°ã—ã„DATABASE_URL: $NEW_DB_URL"

# ä¿®æ­£å¾Œã® .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º
echo "ğŸ“‹ ä¿®æ­£å¾Œã® .env ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹:"
cat .env

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
echo "ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™..."
if command -v nc &> /dev/null; then
    echo "ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ›ã‚¹ãƒˆ: $NEW_HOST:3306"
    
    if nc -z $NEW_HOST 3306 2>/dev/null; then
        echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ›ã‚¹ãƒˆã«æ¥ç¶šå¯èƒ½ã§ã™"
    else
        echo "âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ›ã‚¹ãƒˆã«æ¥ç¶šã§ãã¾ã›ã‚“: $NEW_HOST:3306"
        echo "âš ï¸  ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š"
        echo "   - MySQL ã‚µãƒ¼ãƒ“ã‚¹ãŒå®Ÿè¡Œä¸­ã‹"
        echo "   - ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š"
        echo "   - MySQL ã® bind-address è¨­å®š"
    fi
else
    echo "âš ï¸  nc ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
fi

# MySQL ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ç¢ºèª
echo "ğŸ” MySQL ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™..."
if command -v systemctl &> /dev/null; then
    if systemctl is-active --quiet mysql; then
        echo "âœ… MySQL ã‚µãƒ¼ãƒ“ã‚¹ãŒå®Ÿè¡Œä¸­ã§ã™"
    else
        echo "âŒ MySQL ã‚µãƒ¼ãƒ“ã‚¹ãŒåœæ­¢ã—ã¦ã„ã¾ã™"
        echo "ğŸ”„ MySQL ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã—ã¾ã™ã‹ï¼Ÿ (y/n)"
        read -p "é¸æŠã—ã¦ãã ã•ã„: " start_mysql
        if [[ $start_mysql == "y" ]]; then
            sudo systemctl start mysql
            echo "âœ… MySQL ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã—ã¾ã—ãŸ"
        fi
    fi
else
    echo "âš ï¸  systemctl ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚MySQL ã‚µãƒ¼ãƒ“ã‚¹ã®ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
fi

echo "âœ… Docker ãƒ›ã‚¹ãƒˆæ¥ç¶šä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo "ğŸ”„ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ï¼š"
echo "   docker-compose -f docker-compose.prod.yml down"
echo "   docker-compose -f docker-compose.prod.yml up -d --build" 