// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 言語モデル
model Language {
  id        String   @id @default(cuid())
  code      String   @unique // 言語コード (en, zh, ja, es, pt, de, fr, it)
  name      String   // 言語名
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // リレーション
  pollTranslations PollTranslation[]
  optionTranslations OptionTranslation[]
  users User[]

  @@map("languages")
}

// ユーザーモデル
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  languageId String? // ユーザーの言語設定
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // リレーション
  language Language? @relation(fields: [languageId], references: [id])
  polls    Poll[]
  votes    Vote[]

  @@map("users")
}

// 投票モデル
model Poll {
  id          String   @id @default(cuid())
  isActive    Boolean  @default(true)
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // リレーション
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  options Option[]
  votes  Vote[]
  translations PollTranslation[]

  @@map("polls")
}

// 投票翻訳モデル
model PollTranslation {
  id        String   @id @default(cuid())
  pollId    String
  languageId String
  title     String
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // リレーション
  poll     Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  // ユニーク制約：1投票1言語
  @@unique([pollId, languageId])
  @@map("poll_translations")
}

// 選択肢モデル
model Option {
  id        String   @id @default(cuid())
  pollId    String
  createdAt DateTime @default(now())

  // リレーション
  poll  Poll   @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes Vote[]
  translations OptionTranslation[]

  @@map("options")
}

// 選択肢翻訳モデル
model OptionTranslation {
  id         String   @id @default(cuid())
  optionId   String
  languageId String
  text       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // リレーション
  option   Option   @relation(fields: [optionId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  // ユニーク制約：1選択肢1言語
  @@unique([optionId, languageId])
  @@map("option_translations")
}

// 投票記録モデル
model Vote {
  id        String   @id @default(cuid())
  userId    String?  // 匿名投票の場合はnull
  pollId    String
  optionId  String
  createdAt DateTime @default(now())

  // リレーション
  user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
  poll   Poll   @relation(fields: [pollId], references: [id], onDelete: Cascade)
  option Option @relation(fields: [optionId], references: [id], onDelete: Cascade)

  // ユニーク制約：1ユーザー1投票（匿名投票は制約外）
  @@unique([userId, pollId])
  @@map("votes")
} 